<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Access-Control-Allow-Origin" content="*" />
    <title>Captain's View</title>
    <script type="text/javascript" src="http://maps.google.com/maps/api/js?libraries=geometry&amp;sensor=false"></script>
    <script src="http://www.openlayers.org/api/OpenLayers.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script type="text/javascript">
        var map;
        var serverAddress = "http://localhost:8080";
        var mercator = new OpenLayers.Projection("EPSG:900913");
        var geographic = new OpenLayers.Projection("EPSG:4326");
        var directionsService;
        var markers;
        var fromAddress;
        var toAddress;
        var tablica = [];

        var line_style = {
            strokeColor: "#0000EE",
            strokeOpacity: 0.7,
            strokeWidth: 4,
            pointRadius: 6,
            pointerEvents: "visiblePainted"
        };

        function init() {
            var options = {
                projection: mercator,
                displayProjection: geographic,
                units: "m",
                maxResolution: 156543.0339,
                maxExtent: new OpenLayers.Bounds(-20037508.34, -20037508.34, 20037508.34, 20037508.34),
                numZoomLevels: 1
            };
            map = new OpenLayers.Map('map', options);

            var osm = new OpenLayers.Layer.OSM();

            var gmap = new OpenLayers.Layer.Google("Google", { sphericalMercator: true });

            markers = new OpenLayers.Layer.Markers("points");

            map.addLayers([osm, gmap]);

            var polyline = new OpenLayers.Layer.Vector("Routes");
            map.addLayer(polyline);

            map.addLayer(markers);

            directionsService = new google.maps.DirectionsService();

            map.addControl(new OpenLayers.Control.LayerSwitcher());
            map.addControl(new OpenLayers.Control.MousePosition());

            map.setCenter(new OpenLayers.LonLat(18.4718, 54.37719).transform(geographic, mercator), 15);

            var click = new OpenLayers.Control.Click();
            map.addControl(click);
            click.activate();

            // event dla naciśnięcia na mapie (w inne miejsce niż na markery), który ukrywa popup'y
            var events = map.events;
            events.register("mousedown", map, function (e) {
                hidePopups();
                return true;
            }, true);
            // pobranie markerów z serwera
            getMarkers();

        }

        function getMarkers() {
            $.ajax({
                url: serverAddress + "/gates",
                dataType: "json",
                success: function (response) {
                    if (response) {
                        addMarkers(response.gates);
                    }
                }
            });
        }

        function addMarkers(gates) {
            for (var i = 0; i < gates.length; i++) {
                var label = "<input type='button' value='Wybieram " + gates[i].number + "' onclick='selectMarker(" + gates[i].number + ")'>"
                addMarker(new OpenLayers.LonLat(gates[i].lon, gates[i].lat).transform(geographic, mercator), label, gates[i].number);
            }
        }

        function addMarker(lonlat, tekst, gateNumber) {
            var feature = new OpenLayers.Feature(markers, lonlat);
            feature.closeBox = true;
            feature.popupClass = OpenLayers.Popup.FramedCloud;
            feature.data.popupContentHTML = tekst;
            feature.data.overflow = "auto";

            var marker = feature.createMarker();
            marker.gateNumber = gateNumber;
            var markerClick = function (evt) {
                hidePopups();
                if (this.popup == null) {
                    this.popup = this.createPopup(this.closeBox);
                    map.addPopup(this.popup);
                    this.popup.show();
                } else {
                    this.popup.toggle();
                }
                currentPopup = this.popup;
                OpenLayers.Event.stop(evt);
            };
            marker.events.register("mousedown", feature, markerClick);
            markers.addMarker(marker);
        }

        function selectMarker(num) {
            $.ajax({
                url: serverAddress + "/gates",
                type: "POST",
                data: "{ gate: " + num + " }",
                dataType: "json",
                success: function (response) {
                    if (response) {
                        hidePopups();
                    }
                },
                error: function (err) {
                    if (err && err.responseJSON) {
                        var response = err.responseJSON;

                        // any response action like for 'success'
                    }
                }
            });
        }

        function hidePopups() {
            for (var i = 0; i < map.popups.length; i++) {
                if (map.popups[i] != null) {
                    map.popups[i].hide();
                }
            }
        }

        OpenLayers.Control.Click = OpenLayers.Class(OpenLayers.Control, {
            defaultHandlerOptions: {
                'single': true,
                'double': false,
                'pixelTolerance': 0,
                'stopSingle': false,
                'stopDouble': false
            },
            initialize: function (options) {
                this.handlerOptions = OpenLayers.Util.extend(
                    {}, this.defaultHandlerOptions
                );
                OpenLayers.Control.prototype.initialize.apply(
                    this, arguments
                );
            },
        });
    </script>
</head>
<body onload="init()">
    <div id="map"></div>
    <div id="buttons"></div>
</body>
</html>
